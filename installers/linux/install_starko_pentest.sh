#!/bin/bash

PROFILE_NAME=${1:-StarkoPenTest}
INSTALL_EXTENSIONS=${2:-false}

echo "Installing Starko $PROFILE_NAME Workspace..."

PROFILE_ROOT="$HOME/.config/StarkoProfiles/$PROFILE_NAME"
VSCODE_ROOT="$HOME/.config/Code/User"
WORKSPACE_ROOT=$(pwd)

mkdir -p "$HOME/.config/StarkoProfiles" "$PROFILE_ROOT" "$VSCODE_ROOT/snippets"

PROFILE_PATH="$WORKSPACE_ROOT/profiles/$PROFILE_NAME"

if [ ! -d "$PROFILE_PATH" ]; then
    echo "‚ùå Profile $PROFILE_NAME does not exist at $PROFILE_PATH!"
    echo "Available profiles:"
    ls -la "$WORKSPACE_ROOT/profiles/" 2>/dev/null || echo "No profiles directory found"
    exit 1
fi

echo "üìÅ Copying profile files..."

# Copy .vscode config
if [ -d "$PROFILE_PATH/.vscode" ]; then
    cp -r "$PROFILE_PATH/.vscode/"* "$VSCODE_ROOT/" 2>/dev/null
    echo "‚úÖ VS Code configuration copied"
else
    echo "‚ö†Ô∏è  .vscode directory not found in profile"
fi

# Copy snippets
if [ -d "$PROFILE_PATH/snippets" ] && [ "$(ls -A "$PROFILE_PATH/snippets")" ]; then
    cp -r "$PROFILE_PATH/snippets/"* "$VSCODE_ROOT/snippets/" 2>/dev/null
    echo "‚úÖ Snippets copied"
else
    echo "‚ö†Ô∏è  No snippets found or snippets directory is empty"
fi

# Copy icons
if [ -d "$PROFILE_PATH/icons" ]; then
    cp -r "$PROFILE_PATH/icons" "$PROFILE_ROOT/" 2>/dev/null
    echo "‚úÖ Icons copied"
else
    echo "‚ö†Ô∏è  Icons directory not found"
fi

# Copy workspace file
if ls "$PROFILE_PATH"/*.code-workspace 1> /dev/null 2>&1; then
    cp "$PROFILE_PATH"/*.code-workspace "$PROFILE_ROOT/" 2>/dev/null
    echo "‚úÖ Workspace file copied"
else
    echo "‚ö†Ô∏è  No workspace file found"
fi

# Copy scripts and tools
if [ -d "$WORKSPACE_ROOT/scripts" ]; then
    cp -r "$WORKSPACE_ROOT/scripts" "$PROFILE_ROOT/" 2>/dev/null
    echo "‚úÖ Scripts copied"
fi

if [ -d "$WORKSPACE_ROOT/tools" ]; then
    cp -r "$WORKSPACE_ROOT/tools" "$PROFILE_ROOT/" 2>/dev/null
    echo "‚úÖ Tools copied"
fi

# Install extensions if requested
if [ "$INSTALL_EXTENSIONS" = "true" ]; then
    echo "üì¶ Installing recommended extensions..."
    if command -v code >/dev/null 2>&1; then
        if [ -f "$PROFILE_PATH/.vscode/extensions.json" ]; then
            # Use node or python to parse JSON if jq is not available
            if command -v jq >/dev/null 2>&1; then
                extensions=$(jq -r '.recommendations[]' "$PROFILE_PATH/.vscode/extensions.json")
            else
                extensions=$(grep -o '"recommendations":\[[^]]*\]' "$PROFILE_PATH/.vscode/extensions.json" | grep -o '"[^"]*"' | tr -d '"' | grep -v recommendations)
            fi
            
            for extension in $extensions; do
                echo "Installing $extension..."
                code --install-extension "$extension" --force
            done
            echo "‚úÖ Extensions installed"
        else
            echo "‚ùå extensions.json not found"
        fi
    else
        echo "‚ùå 'code' command not found. Please make sure VS Code is installed and in PATH."
    fi
fi

echo ""
echo "üéâ Installation complete!"
echo "üìÇ Profile location: $PROFILE_ROOT"
echo "üõ†Ô∏è  Available scripts in: $PROFILE_ROOT/scripts"
echo ""
echo "üöÄ Next steps:"
echo "   1. Restart VS Code"
echo "   2. Open command palette (Ctrl+Shift+P)"
echo "   3. Run 'Developer: Reload Window'"
echo "   4. Start using snippets with prefixes: burpscan, sqli, wifi-audit"